<!DOCTYPE html>
<html>
<head>
    <title>ðŸŽˆ Birthday Game ðŸŽ‚</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Your existing styles remain unchanged */
        /* ... */
    </style>
</head>
<body>
    <div id="introScreen">
        <h1>ðŸŽˆ Happy Birthday Alina! ðŸŽ‚<br>Catch your friends and avoid the bad stuff!</h1>
        <button id="startButton">Start Game</button>
    </div>

    <div id="gameContainer">
        <!-- Your existing game HTML -->
        <div id="score">Score: 0</div>
        <div id="gameArea">
            <div id="player"></div>
        </div>
        <div id="gameOver">
            <h2>Game Over!</h2>
            <button onclick="restartGame()">Play Again</button>
        </div>
    </div>

    <script>
        // Move all variable declarations to the top
        let gameArea = document.getElementById('gameArea');
        let player = document.getElementById('player');
        let scoreElement = document.getElementById('score');
        let gameOverScreen = document.getElementById('gameOver');

        let keys = {};
        let speed = 5;
        let friends = [];
        let enemies = [];
        let score = 0;
        let gameStartTime;

        // Initialize audio before using it
        let audio = {
            background: new Audio('assets/background.mp3'),
            friend: new Audio('assets/friend.mp3'),
            enemy: new Audio('assets/enemy.mp3'),
            gameOver: new Audio('assets/gameover.mp3')
        };

        audio.background.loop = true;

        // Event listeners for key presses
        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // Define all functions after variables are declared
        function movePlayer() {
            let rect = player.getBoundingClientRect();
            if (keys['ArrowLeft'] && rect.left > 0) {
                player.style.left = rect.left - speed + 'px';
            }
            if (keys['ArrowRight'] && rect.right < window.innerWidth) {
                player.style.left = rect.left + speed + 'px';
            }
        }

        function spawnFriend() {
            let friend = document.createElement('div');
            friend.classList.add('friend');
            friend.style.left = Math.random() * (window.innerWidth - 50) + 'px';
            friend.style.top = '-50px';
            gameArea.appendChild(friend);
            friends.push(friend);
        }

        function spawnEnemy() {
            let enemy = document.createElement('div');
            enemy.classList.add('enemy');
            enemy.style.left = Math.random() * (window.innerWidth - 50) + 'px';
            enemy.style.top = '-50px';
            gameArea.appendChild(enemy);
            enemies.push(enemy);
        }

        function isColliding(a, b) {
            let rect1 = a.getBoundingClientRect();
            let rect2 = b.getBoundingClientRect();

            return !(
                rect1.top > rect2.bottom ||
                rect1.bottom < rect2.top ||
                rect1.left > rect2.right ||
                rect1.right < rect2.left
            );
        }

        function updateGame() {
            movePlayer();

            friends.forEach((friend, index) => {
                let rect = friend.getBoundingClientRect();
                if (rect.top > window.innerHeight) {
                    friend.remove();
                    friends.splice(index, 1);
                } else {
                    friend.style.top = rect.top + 2 + 'px';

                    if (isColliding(friend, player)) {
                        audio.friend.play();
                        score += 10;
                        scoreElement.innerText = 'Score: ' + score;
                        friend.remove();
                        friends.splice(index, 1);
                    }
                }
            });

            enemies.forEach((enemy, index) => {
                let rect = enemy.getBoundingClientRect();
                if (rect.top > window.innerHeight) {
                    enemy.remove();
                    enemies.splice(index, 1);
                } else {
                    enemy.style.top = rect.top + 4 + 'px';

                    if (isColliding(enemy, player)) {
                        audio.enemy.play();
                        endGame();
                    }
                }
            });

            if (gameOverScreen.style.display !== 'flex') {
                requestAnimationFrame(updateGame);
            }
        }

        function startSpawning() {
            spawnFriend();
            spawnEnemy();

            if (gameOverScreen.style.display !== 'flex') {
                setTimeout(startSpawning, 1000);
            }
        }

        function endGame() {
            audio.background.pause();
            audio.gameOver.play();
            gameOverScreen.style.display = 'flex';
        }

        function restartGame() {
            gameOverScreen.style.display = 'none';
            score = 0;
            scoreElement.innerText = 'Score: 0';
            friends.forEach(friend => friend.remove());
            enemies.forEach(enemy => enemy.remove());
            friends = [];
            enemies = [];
            player.style.left = 'calc(50% - 25px)';
            audio.background.currentTime = 0;
            audio.background.play();
            requestAnimationFrame(updateGame);
            startSpawning();
        }

        // Define the startGame function after variables and functions
        function startGame() {
            // Hide intro screen and show game
            document.getElementById('introScreen').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';
            
            // Start background music
            audio.background.play();
            
            // Initialize game
            gameStartTime = Date.now();
            requestAnimationFrame(updateGame);
            startSpawning();
        }

        // Add click handler for start button
        document.getElementById('startButton').addEventListener('click', startGame);

        // Remove the automatic start on window load
        // window.addEventListener('load', () => { ... });
    </script>
</body>
</html>
